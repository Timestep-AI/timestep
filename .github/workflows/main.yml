name: "Comment a Plan on a PR"

on: [pull_request]

env:
  CLOUD_INSTANCE_PROVIDER: ${{ vars.CLOUD_INSTANCE_PROVIDER }}
  DO_TOKEN: ${{ secrets.DO_TOKEN }}
  PREFECT_CLOUD_WORKSPACE: ${{ vars.PREFECT_CLOUD_WORKSPACE }}
  SSH_PUBLIC_KEY: ${{ vars.SSH_PUBLIC_KEY }}
  STACK_ID: ${{ vars.STACK_ID }}
  TF_API_TOKEN: ${{ secrets.TF_API_TOKEN }}

permissions:
  contents: read
  pull-requests: write

jobs:
  terraform:
    name: "Terraform CDK Diff"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: "18.15.0"
      - run: |
          npm install -g cdktf-cli@0.16.3

      # - name: Install dependencies
      #   run: yarn install

      # - name: Generate module and provider bindings
      #   run: npx cdktf-cli get

      # # Remove this step if you don't have any
      # - name: Run unit tests
      #   run: yarn test

      - uses: actions/setup-python@v4
        with:
          python-version: '3.11.3'
      - run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade pipx
          python -m pipx ensurepath
          pipx install poetry
          poetry install
          poetry run prefect cloud login --key ${{ secrets.PREFECT_API_KEY }} --workspace ${{ env.PREFECT_CLOUD_WORKSPACE }}

      - name: Run Terraform CDK
        uses: hashicorp/terraform-cdk-action@v0.1.27
        with:
          terraformVersion: 1.3.9
          cdktfVersion: 0.16.3
          stackName: ${{ env.STACK_ID }}
          mode: plan-only
          terraformCloudToken: ${{ secrets.TF_API_TOKEN }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
