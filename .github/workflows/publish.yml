name: Publish Packages

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: 'lib/typescript/pnpm-lock.yaml'
      
      - name: Install Python dependencies
        run: |
          cd lib/python
          uv pip install -e ".[dev]"
      
      - name: Install TypeScript dependencies
        run: |
          cd lib/typescript
          pnpm install --frozen-lockfile
      
      - name: Run Python tests
        run: |
          cd lib/python
          uv run python -m pytest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      
      - name: Run TypeScript tests
        run: |
          cd lib/typescript
          pnpm test
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  publish-python:
    name: Publish Python Package to PyPI
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Read version from pyproject.toml
        id: read_version
        run: |
          cd lib/python
          VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"
      
      - name: Build package
        run: |
          cd lib/python
          uv build
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: lib/python/dist/
          password: ${{ secrets.PYPI_API_TOKEN }}

  publish-typescript:
    name: Publish TypeScript Package to npm
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      id-token: write  # Required for trusted publishing to npm
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'
          cache-dependency-path: 'lib/typescript/pnpm-lock.yaml'
      
      - name: Read version from package.json
        id: read_version
        run: |
          cd lib/typescript
          VERSION=$(grep -E '"version"' package.json | sed 's/.*"version": "\(.*\)".*/\1/' | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"
      
      - name: Install dependencies
        run: |
          cd lib/typescript
          pnpm install --frozen-lockfile
      
      - name: Build package
        run: |
          cd lib/typescript
          pnpm run build
      
      - name: Publish to npm
        run: |
          cd lib/typescript
          pnpm publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  deploy-docs:
    name: Deploy Documentation to GitHub Pages
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install documentation dependencies
        run: |
          cd docs
          pip install -r requirements-docs.txt
      
      - name: Build documentation
        run: |
          cd docs
          mkdocs build
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/site
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

